@page "/proj-code-mng";
@{
  /* description : 프로젝트 master 코드 정보
  * title : 프로젝트 코드 정보
      * sort : 2
      * credt : 2025-07-02
      * author : quristyle
      */
}

@inherits PageBaseComponent

<RadzenCard >
  <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" >

    
    <QuriSearchs AllLoadComplete=OnLoadWrk >
      <QuriDropDown @bind-Value="srtype" CodeId="projlist" />
      <QuriDropDown @bind-Value="dbType" CodeId="projdb" Etc0=@srtype?.Code IsEtcFix=true  />
      </QuriSearchs>


    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
      <RadzenButton Click="@OnLoadWrk" Text="Search" />
    </RadzenStack>

  </RadzenStack>
</RadzenCard>



<RadzenSplitter Orientation="Orientation.Vertical" class="context-body-row" style=" border: 1px solid rgba(0,0,0,.08);">

    
  <!-- 위쪽 -->
  <RadzenSplitterPane  Size="40%" Min="10%" Max="90%">

        <QuriDynamicGrid SaveBtnEvent=SaveBtnEvent
                         DeleteBtnEvent=DeleteBtnEvent ReqData=Data SItemsChanged=OnDbInfoChange />


    </RadzenSplitterPane>
    <!-- 아래쪽 -->
    <RadzenSplitterPane Size="60%" Min="10%" Max="90%">

        
    <RadzenSplitter Orientation="Orientation.Horizontal">
        
        <!-- 왼쪽 -->
        <RadzenSplitterPane Size="40%" Min="20%" Max="80%">

                <QuriDynamicGrid ReqData=DbPropData SaveBtnEvent=SaveDBPropEvent SItemsChanged=OnDbPropChange />
        </RadzenSplitterPane>
        <!-- 오른쪽 -->
        <RadzenSplitterPane Size="60%" Min="20%" Max="80%">

                <QuriCodeEditor @ref="_editProc" />

        </RadzenSplitterPane>





        </RadzenSplitter>






    </RadzenSplitterPane>

    </RadzenSplitter>






@code {

  public CommonCode? srtype { get; set; }
  CommonCode? dbType { get; set; }

  protected override async Task OnInitializedAsync() {
    await base.OnInitializedAsync();
  }

  public ResultInfo<Dictionary<string, object>>? Data { get; set; }
  public List<IDictionary<string, object>>? SelDbInfo { get; set; }


  public ResultInfo<Dictionary<string, object>>? DbPropData { get; set; }
  public IList<IDictionary<string, object>>? SelDbProp { get; set; }



  private QuriCodeEditor? _editProc;


  protected async Task OnLoadWrk() {
    Data = await DbCont<Dictionary<string, object>>("sp_projdblist", new Dictionary<string, string>() {
    { "proj_rid",  srtype?.Code ?? string.Empty }
    });
  }

  protected async Task OnSaveWrk() {
    var sp_fmt = await _editProc.GetValue();
    await DbSave<Dictionary<string, object>>("sp_dev_db_prop_exec", new Dictionary<string, string>() {
    { "db_rid",  SelDbProp.FirstOrDefault()["db_rid"].ToString() },
    { "db_prid",  SelDbProp.FirstOrDefault()["db_prid"].ToString() },
    { "db_pkey",  SelDbProp.FirstOrDefault()["db_pkey"].ToString() },
    { "db_pvalue",  sp_fmt },
    });
  }


  

  private async Task SaveBtnEvent(IDictionary<string, object> dic) {
    var req = WasmUtil.JoinDictionaries(dic, new Dictionary<string, string>() { { "stp", "sp_projdbsave" } });

    var saveobj = await DbSave<IDictionary<string, object>>("sp_projdbsave", req);
  }



  private async Task DeleteBtnEvent(IDictionary<string, object> dic) {
    var req = WasmUtil.JoinDictionaries(dic, new Dictionary<string, string>() { });

    var saveobj = await DbDelete<IDictionary<string, object>>("sp_projdbdel", req);
  }


  private async Task OnDbInfoChange(IList<IDictionary<string, object>> args) {
    DbPropData = await DbCont<Dictionary<string, object>>("sp_dev_db_prop_exec", new Dictionary<string, string>() {
    { "db_rid",  args.FirstOrDefault()["db_rid"].ToString() }
    });
  }


  private async Task OnDbPropChange(IList<IDictionary<string, object>> args) {
    SelDbProp = args;
    _editProc.SetValue(args.FirstOrDefault()["db_pvalue"].ToString());

  }

  


  private async Task SaveDBPropEvent(IDictionary<string, object> dic) {
    var req = WasmUtil.JoinDictionaries(dic, new Dictionary<string, string>() {  });

    await DbSave<IDictionary<string, object>>("sp_dev_db_prop_exec", req);
  }


}
